{% extends "layouts/base.html" %}

{% block content %}
<div class="space-y-6 text-slate-900 dark:text-slate-100">

  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-bold mb-1">
        ثبت قیمت خرید DKPCها – {{ invoice.title|default:"بدون عنوان" }}
      </h1>
      <p class="text-sm text-gray-600 dark:text-gray-300">
        در این صفحه می‌توانید برای هر کد تنوع (DKPC) قیمت خرید را
        یا از طریق فرم پایین وارد کنید، یا با فایل اکسل ثبت و بارگذاری کنید.
      </p>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
        (امکان «دانلود فایل نمونهٔ اکسل قیمت خرید» در مرحلهٔ بعدی پروژه به‌صورت کامل پیاده‌سازی می‌شود.)
      </p>
    </div>
    {# اگر بعداً خواستی دکمه دانلود واقعی داشته باشی، همین‌جا فعالش می‌کنیم. #}
  </div>

  {% if upload_error %}
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-200 text-sm rounded-lg px-3 py-2">
      {{ upload_error }}
    </div>
  {% endif %}

  <!-- فرم ۱: ثبت قیمت خرید از طریق فرم وب -->
  <div class="bg-white dark:bg-slate-900 rounded-xl p-4 shadow text-slate-900 dark:text-slate-100">
    <h2 class="text-lg font-semibold mb-3">روش ۱ – ثبت قیمت خرید در خود سایت</h2>
    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
      برای هر DKPC یک بار قیمت خرید را وارد کنید. این قیمت در حساب کاربری شما ذخیره می‌شود
      و برای صورتحساب‌های بعدی هم استفاده خواهد شد.
    </p>

    {% if items %}
      <form method="post" class="space-y-3">
        {% csrf_token %}
        <div class="overflow-x-auto max-h-[70vh]">
          <table class="min-w-full text-xs md:text-sm">
            <thead class="sticky top-0 bg-white dark:bg-slate-900">
              <tr class="border-b text-left">
                <th class="py-2 px-2">ردیف</th>
                <th class="py-2 px-2">DKPC</th>
                <th class="py-2 px-2">عنوان تنوع</th>
                <th class="py-2 px-2 text-right">تعداد نقدی</th>
                <th class="py-2 px-2 text-right">تعداد اعتباری</th>
                <th class="py-2 px-2 text-right">مجموع تعداد</th>
                <th class="py-2 px-2 text-right">میانگین قیمت فروش (ریال)</th>
                <th class="py-2 px-2 text-right">قیمت خرید (ریال)</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
                <tr class="border-b last:border-0">
                  <td class="py-2 px-2">{{ forloop.counter }}</td>
                  <td class="py-2 px-2 font-mono">{{ item.dkpc }}</td>
                  <td class="py-2 px-2">{{ item.title }}</td>
                  <td class="py-2 px-2 text-right">{{ item.cash_qty }}</td>
                  <td class="py-2 px-2 text-right">{{ item.credit_qty }}</td>
                  <td class="py-2 px-2 text-right">{{ item.total_qty }}</td>
                  <td class="py-2 px-2 text-right">
                    {{ item.avg_sale|default_if_none:"0"|floatformat:0 }}
                  </td>
                  <td class="py-2 px-2 text-right">
                    <input
                      type="text"
                      name="price_{{ item.dkpc }}"
                      value="{{ item.purchase_price|default_if_none:'0' }}"
                      class="w-32 md:w-40 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-right text-xs md:text-sm"
                    />
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="flex justify-end">
          <button
            type="submit"
            class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-semibold bg-emerald-600 text-white hover:bg-emerald-700"
          >
            ذخیره قیمت‌ها و محاسبه سود
          </button>
        </div>
      </form>
    {% else %}
      <p class="text-sm text-gray-600 dark:text-gray-300">
        برای این صورتحساب هیچ ردیف فروشی یافت نشد.
      </p>
    {% endif %}
  </div>

  <!-- فرم ۲: آپلود فایل اکسل قیمت خرید -->
  <div class="bg-white dark:bg-slate-900 rounded-xl p-4 shadow text-slate-900 dark:text-slate-100">
    <h2 class="text-lg font-semibold mb-3">روش ۲ – ثبت قیمت خرید با فایل اکسل</h2>
    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
      می‌توانید یک فایل اکسل شامل ستون‌های «DKPC» و «قیمت خرید (ریال)» آماده کنید
      و در این قسمت بارگذاری نمایید تا قیمت‌ها به‌صورت خودکار برای این صورتحساب اعمال شود.
    </p>

    <form method="post" enctype="multipart/form-data" class="space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium mb-1">
          انتخاب فایل اکسل قیمت خرید
        </label>
        <input
          type="file"
          name="price_excel"
          accept=".xlsx,.xls"
          class="block w-full text-sm text-gray-700 dark:text-gray-200"
        />
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          لطفاً ساختار ستون‌ها را تغییر ندهید؛ فقط مقدار ستون «قیمت خرید (ریال)» را وارد یا اصلاح کنید.
        </p>
      </div>

      <button
        type="submit"
        name="upload_excel"
        class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700"
      >
        بارگذاری فایل و اعمال قیمت‌ها
      </button>
    </form>
  </div>

  <div class="flex justify-end">
    <a
      href="{% url 'digihesabyar:invoice_detail' invoice_id=invoice.id %}"
      class="inline-flex items-center px-3 py-2 rounded-lg text-sm font-semibold bg-gray-200 hover:bg-gray-300 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-900 dark:text-slate-100"
    >
      بازگشت به جزئیات صورتحساب
    </a>
  </div>

</div>
{% endblock %}
