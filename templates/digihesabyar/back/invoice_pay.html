{% extends "layouts/base.html" %}

{% block content %}
<div class="space-y-6 text-slate-900 dark:text-slate-100">

  <div>
    <h1 class="text-2xl font-bold mb-1">پرداخت هزینه صورتحساب</h1>
    <p class="text-sm text-gray-600 dark:text-gray-300">
      برای فعال‌شدن گزارش سود و زیان، نمودارها و امکان دانلود فایل اکسل / PDF، باید هزینه این صورتحساب را پرداخت کنید.
      پس از پرداخت، همیشه به نتایج این صورتحساب دسترسی خواهید داشت.
    </p>
  </div>

  <div class="bg-white dark:bg-slate-900 rounded-xl p-4 shadow text-sm space-y-3">
    <!-- اطلاعات صورتحساب -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <div class="font-semibold">
          {{ invoice.title|default:"بدون عنوان" }}
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          شناسه صورتحساب: #{{ invoice.id }} –
          تعداد ردیف‌های فروش: {{ invoice.row_count }}
        </div>
      </div>

      <div class="text-right">
        <div class="text-xs text-gray-500 dark:text-gray-400">هزینه این صورتحساب</div>
        <div class="text-xl font-bold">
          {{ price_rial|floatformat:0 }} ریال
        </div>
        {% if price_rial %}
          {% widthratio price_rial 10 1 as price_toman %}
          <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            (حدود {{ price_toman }} تومان)
          </div>
        {% else %}
          <div class="text-xs text-red-500 mt-1">
            هنوز مبلغی برای این صورتحساب محاسبه نشده است.
          </div>
        {% endif %}
      </div>
    </div>

    <!-- موجودی کیف پول و کمبود -->
    <div class="border-t border-slate-200 dark:border-slate-800 pt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">موجودی فعلی کیف پول شما</div>
        <div class="text-lg font-semibold">
          {{ balance|floatformat:0 }} ریال
        </div>
      </div>

      <div class="md:text-right">
        {% if needed_rial > 0 %}
          {% widthratio needed_rial 10 1 as needed_toman %}
          <p class="text-sm text-red-500">
            موجودی کیف پول کمتر از مبلغ مورد نیاز است.
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            مبلغ مورد نیاز برای این صورتحساب:
            {{ needed_rial|floatformat:0 }} ریال (حدود {{ needed_toman }} تومان)
          </p>
        {% else %}
          <p class="text-sm text-emerald-600">
            موجودی کیف پول شما برای پرداخت این صورتحساب کافی است.
          </p>
        {% endif %}
      </div>
    </div>

    <!-- تعرفه‌ها -->
    <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
      تعرفه‌ها برای هر صورتحساب:
      <br>
      – تا ۵۰۰ ردیف: ۴۹٬۰۰۰ تومان (۴۹۰٬۰۰۰ ریال)
      <br>
      – ۵۰۱ تا ۱٬۰۰۰ ردیف: ۸۹٬۰۰۰ تومان (۸۹۰٬۰۰۰ ریال)
      <br>
      – بیش از ۱٬۰۰۰ ردیف: ۱۲۹٬۰۰۰ تومان (۱٬۲۹۰٬۰۰۰ ریال)
      <br>
      (هر ۱٬۰۰۰ تومان = ۱۰٬۰۰۰ ریال؛ محاسبات سیستم بر اساس ریال است.)
    </div>

    {% if error_message %}
      <div class="mt-3 text-sm text-red-600">
        {{ error_message }}
      </div>
    {% endif %}

    <!-- دکمه‌ها -->
    <div class="flex flex-wrap gap-2 justify-end pt-3 border-t border-slate-200 dark:border-slate-800 mt-3">
      <a
        href="{% url 'digihesabyar:wallet' %}"
        class="inline-flex items-center px-3 py-2 rounded-lg text-xs md:text-sm font-semibold bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-100"
      >
        مشاهده کیف پول
      </a>

      <a
        href="{% url 'digihesabyar:invoice_detail' invoice_id=invoice.id %}"
        class="inline-flex items-center px-3 py-2 rounded-lg text-xs md:text-sm font-semibold bg-gray-200 hover:bg-gray-300 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-900 dark:text-slate-100"
      >
        بازگشت به جزئیات صورتحساب
      </a>

      {% if needed_rial > 0 %}
        <a
          href="{% url 'digihesabyar:wallet_topup' %}?amount={{ needed_rial }}&next={% url 'digihesabyar:invoice_pay' invoice_id=invoice.id %}"
          class="inline-flex items-center px-3 py-2 rounded-lg text-xs md:text-sm font-semibold bg-amber-500 text-white hover:bg-amber-600"
        >
          شارژ کیف پول و پرداخت
        </a>
      {% endif %}

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="confirm_wallet" value="1">
        <button
          type="submit"
          {% if needed_rial > 0 or not price_rial %}
            disabled
            class="inline-flex items-center px-4 py-2 rounded-lg text-xs md:text-sm font-semibold bg-blue-400 text-white opacity-60 cursor-not-allowed"
          {% else %}
            class="inline-flex items-center px-4 py-2 rounded-lg text-xs md:text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700"
          {% endif %}
        >
          تایید و پرداخت از کیف پول
        </button>
      </form>
    </div>
  </div>

</div>
{% endblock %}
