{% extends "layouts/base.html" %}

{% block content %}
<div class="page-body">
  <div class="container-xl">
    <div class="space-y-4">

      <!-- کارت هدر صورتحساب -->
      <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-4 md:p-6 border border-slate-200/80 dark:border-slate-700/60">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">

          <!-- اطلاعات اصلی صورتحساب -->
          <div class="space-y-2">
            <h1 class="text-lg md:text-xl font-semibold text-gray-900 dark:text-white">
              جزئیات صورتحساب
              <span class="font-mono text-sm text-gray-500 dark:text-gray-400">
                #{{ invoice.id }}
              </span>
            </h1>

            {% if invoice.title %}
              <div class="text-sm text-gray-700 dark:text-gray-300">
                عنوان: {{ invoice.title }}
              </div>
            {% endif %}

            <div class="flex flex-wrap gap-3 text-xs md:text-sm text-gray-500 dark:text-gray-400">
              <div>
                تاریخ آپلود:
                {{ invoice.uploaded_at|date:"Y-m-d H:i" }}
              </div>

              <div>
                تعداد ردیف‌های فروش:
                <span class="font-semibold text-gray-800 dark:text-gray-100">
                  {{ invoice.row_count|default:"0" }}
                </span>
              </div>

              <div>
                وضعیت پردازش:
                <span
                  class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                  {% if invoice.status == 'done' %}
                    bg-emerald-100 text-emerald-800
                  {% elif invoice.status == 'processing' %}
                    bg-blue-100 text-blue-800
                  {% elif invoice.status == 'error' %}
                    bg-red-100 text-red-800
                  {% else %}
                    bg-gray-100 text-gray-800
                  {% endif %}
                ">
                  {{ invoice.get_status_display }}
                </span>
              </div>

              <div>
                وضعیت پرداخت:
                {% if invoice.is_paid %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800">
                    پرداخت شده
                  </span>
                {% else %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">
                    پرداخت نشده
                  </span>
                {% endif %}
              </div>

              {% if invoice.processing_price %}
                <div>
                  هزینه پردازش:
                  <span class="font-semibold text-gray-800 dark:text-gray-100">
                    {{ invoice.processing_price|floatformat:0 }} ریال
                  </span>
                </div>
              {% endif %}
            </div>

            {% if invoice.error_message %}
              {% if user.is_staff and invoice.error_message %}
                <div class="alert alert-warning">
                  <strong>گزارش پردازش (فقط برای ادمین):</strong><br>
                  {{ invoice.error_message|linebreaksbr }}
                </div>
              {% endif %}

              {% if not user.is_staff and invoice.status == "error" %}
                <div class="alert alert-danger">
                  در پردازش این صورتحساب خطایی رخ داده است. لطفاً با پشتیبانی تماس بگیرید.
                </div>
              {% endif %}
            {% endif %}
          </div>

          <!-- دکمه‌ها -->
          <div class="flex flex-col items-end gap-3 w-full md:w-auto">
            <div class="flex flex-wrap gap-2 justify-end">
              <a
                href="{% url 'digihesabyar:dashboard' %}"
                class="inline-flex items-center px-3 py-2 rounded-lg text-xs md:text-sm font-semibold border border-slate-300 text-gray-700 hover:bg-slate-50 dark:border-slate-600 dark:text-gray-100 dark:hover:bg-slate-800"
              >
                بازگشت به لیست صورتحساب‌ها
              </a>
            </div>

            <div class="flex flex-wrap gap-2 justify-end">
              <a
                href="{% url 'digihesabyar:invoice_prices' invoice_id=invoice.id %}"
                class="inline-flex items-center px-3 py-2 rounded-lg text-xs md:text-sm font-semibold bg-emerald-600 text-white hover:bg-emerald-700"
              >
                ثبت / ویرایش قیمت خرید
              </a>

              {% if invoice.is_paid %}
                <a
                  href="{% url 'digihesabyar:export_invoice' invoice_id=invoice.id %}"
                  class="inline-flex items-center px-3 py-2 rounded-lg text-xs md:text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700"
                >
                  دانلود خروجی اکسل سود و زیان
                </a>
              {% else %}
                <button
                  type="button"
                  class="inline-flex items-center px-3 py-2 rounded-lg text-xs md:text-sm font-semibold bg-gray-400 text-white cursor-not-allowed"
                  title="برای دانلود خروجی اکسل، ابتدا باید هزینه این صورتحساب را پرداخت کنید."
                  disabled
                >
                  دانلود خروجی اکسل سود و زیان
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- هشدار پرداخت در صورت وجود هزینه و عدم پرداخت -->
      {% if invoice.processing_price > 0 and not invoice.is_paid %}
        <div class="bg-amber-50 border border-amber-200 text-amber-800 text-xs md:text-sm rounded-lg px-3 py-2">
          برای مشاهده کامل جزئیات سود و زیان و دانلود خروجی اکسل، باید هزینه این صورتحساب را پرداخت کنید.
          <a
            href="{% url 'digihesabyar:invoice_pay' invoice_id=invoice.id %}"
            class="underline font-semibold text-amber-900 hover:text-amber-950"
          >
            رفتن به صفحه پرداخت
          </a>
        </div>
      {% endif %}

      {% if invoice.is_paid %}
        <!-- خلاصه سود و زیان کلی -->
        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-4 md:p-6 border border-slate-200/80 dark:border-slate-700/60">
          <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">
            خلاصه سود و زیان
          </h2>

          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 text-xs md:text-sm">
            <div class="rounded-lg bg-slate-50 dark:bg-slate-800/60 p-3 border border-slate-200/80 dark:border-slate-700/60">
              <div class="text-gray-600 dark:text-gray-300 mb-1">جمع فروش</div>
              <div class="font-semibold text-gray-900 dark:text-white">
                {{ summary.total_sale|default_if_none:"0"|floatformat:0 }} ریال
              </div>
            </div>

            <div class="rounded-lg bg-slate-50 dark:bg-slate-800/60 p-3 border border-slate-200/80 dark:border-slate-700/60">
              <div class="text-gray-600 dark:text-gray-300 mb-1">جمع سود (یا زیان)</div>
              <div class="font-semibold {% if summary.total_profit < 0 %}text-red-600{% else %}text-emerald-600{% endif %}">
                {{ summary.total_profit|default_if_none:"0"|floatformat:0 }} ریال
              </div>
            </div>

            <div class="rounded-lg bg-slate-50 dark:bg-slate-800/60 p-3 border border-slate-200/80 dark:border-slate-700/60">
              <div class="text-gray-600 dark:text-gray-300 mb-1">جمع کمیسیون</div>
              <div class="font-semibold text-gray-900 dark:text-white">
                {{ summary.total_commission|default_if_none:"0"|floatformat:0 }} ریال
              </div>
            </div>

            <div class="rounded-lg bg-slate-50 dark:bg-slate-800/60 p-3 border border-slate-200/80 dark:border-slate-700/60">
              <div class="text-gray-600 dark:text-gray-300 mb-1">جمع هزینه ارسال</div>
              <div class="font-semibold text-gray-900 dark:text-white">
                {{ summary.total_shipping|default_if_none:"0"|floatformat:0 }} ریال
              </div>
            </div>

            <div class="rounded-lg bg-slate-50 dark:bg-slate-800/60 p-3 border border-slate-200/80 dark:border-slate-700/60">
              <div class="text-gray-600 dark:text-gray-300 mb-1">جمع هزینه پردازش</div>
              <div class="font-semibold text-gray-900 dark:text-white">
                {{ summary.total_processing|default_if_none:"0"|floatformat:0 }} ریال
              </div>
            </div>

            <div class="rounded-lg bg-slate-50 dark:bg-slate-800/60 p-3 border border-slate-200/80 dark:border-slate-700/60">
              <div class="text-gray-600 dark:text-gray-300 mb-1">درآمد توسعه پلتفرم (اعتباری)</div>
              <div class="font-semibold text-gray-900 dark:text-white">
                {{ summary.total_platform_dev|default_if_none:"0"|floatformat:0 }} ریال
              </div>
            </div>
          </div>
        </div>

        <!-- جدول ردیف‌های صورتحساب -->
        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-4 md:p-6 border border-slate-200/80 dark:border-slate-700/60">
          <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">
            لیست ردیف‌های صورتحساب
          </h2>

          {% if rows %}
            <div class="overflow-x-auto -mx-2 md:mx-0">
              <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-slate-50 dark:bg-slate-800">
                  <tr class="border-b border-slate-200 dark:border-slate-700 text-right">
                    <th class="py-2 px-2">نوع فروش</th>
                    <th class="py-2 px-2">وضعیت</th>
                    <th class="py-2 px-2">شماره سفارش</th>
                    <th class="py-2 px-2">DKPC</th>
                    <th class="py-2 px-2">عنوان تنوع</th>
                    <th class="py-2 px-2">قیمت فروش (ریال)</th>
                    <th class="py-2 px-2">قیمت خرید (ریال)</th>
                    <th class="py-2 px-2">کمیسیون (ریال)</th>
                    <th class="py-2 px-2">هزینه ارسال (ریال)</th>
                    <th class="py-2 px-2">هزینه پردازش (ریال)</th>
                    <th class="py-2 px-2">درآمد توسعه پلتفرم (ریال)</th>
                    <th class="py-2 px-2">سود / زیان (ریال)</th>
                    <th class="py-2 px-2">درصد سود</th>
                  </tr>
                </thead>

                <tbody>
                  {% for r in rows %}
                    <tr class="border-b border-slate-100 dark:border-slate-800 last:border-0">
                      <td class="py-2 px-2 whitespace-nowrap">
                        {{ r.sale_type_label }}
                      </td>
                      <td class="py-2 px-2 whitespace-nowrap">
                        {{ r.status_text }}
                      </td>
                      <td class="py-2 px-2 whitespace-nowrap font-mono">
                        {{ r.order_id }}
                      </td>
                      <td class="py-2 px-2 whitespace-nowrap font-mono">
                        {{ r.dkpc }}
                      </td>
                      <td class="py-2 px-2">
                        {{ r.title }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ r.sale_amount|default_if_none:"0"|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ r.purchase_price|default_if_none:"0"|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ r.commission_amount|default_if_none:"0"|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ r.shipping_fee|default_if_none:"0"|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ r.processing_fee|default_if_none:"0"|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ r.platform_dev_revenue|default_if_none:"0"|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right {% if r.profit_display < 0 %}text-red-600{% else %}text-emerald-600{% endif %}">
                        {{ r.profit_display|default_if_none:"0"|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ r.profit_percent_str }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-sm text-gray-600 dark:text-gray-300">
              هنوز هیچ ردیفی برای این صورتحساب ثبت نشده است.
            </p>
          {% endif %}
        </div>

        <!-- خلاصه کالاها بر اساس DKPC -->
        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-4 md:p-6 border border-slate-200/80 dark:border-slate-700/60">
          <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">
            خلاصه کالاها بر اساس DKPC
          </h2>

          {% if product_summary %}
            <div class="overflow-x-auto -mx-2 md:mx-0 mb-6">
              <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-slate-50 dark:bg-slate-800">
                  <tr class="border-b border-slate-200 dark:border-slate-700 text-right">
                    <th class="py-2 px-2">DKPC</th>
                    <th class="py-2 px-2">عنوان تنوع</th>
                    <th class="py-2 px-2">تعداد فروش</th>
                    <th class="py-2 px-2">جمع فروش (ریال)</th>
                    <th class="py-2 px-2">جمع سود (ریال)</th>
                    <th class="py-2 px-2">حاشیه سود نسبت به فروش</th>
                  </tr>
                </thead>

                <tbody>
                  {% for p in product_summary %}
                    <tr class="border-b border-slate-100 dark:border-slate-800 last:border-0">
                      <td class="py-2 px-2 font-mono">
                        {{ p.dkpc }}
                      </td>
                      <td class="py-2 px-2">
                        {{ p.title }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ p.qty }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ p.sale|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ p.profit|floatformat:0 }}
                      </td>
                      <td class="py-2 px-2 text-right">
                        {{ p.margin_str }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- نمودار سود ۱۰ کالای اول -->
            <div>
              <h3 class="text-md font-semibold mb-2 text-gray-900 dark:text-white">
                نمودار سود کالاها (۱۰ کالای اول)
              </h3>
              <p class="text-xs md:text-sm text-gray-600 dark:text-gray-300 mb-3">
                در این نمودار، ۱۰ کالایی که بیشترین سود کل را داشته‌اند نمایش داده می‌شود.
              </p>

              <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-3 border border-slate-200/80 dark:border-slate-700/60">
                <canvas id="profitChart" height="160"></canvas>
              </div>
            </div>
          {% else %}
            <p class="text-sm text-gray-600 dark:text-gray-300">
              هنوز داده‌ای برای خلاصه کالاها ثبت نشده است.
            </p>
          {% endif %}
        </div>

        {% if product_summary %}
          <!-- اسکریپت Chart.js برای نمودار سود -->
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script>
            (function () {
              const labels = [
                {% for p in product_summary|slice:":10" %}
                  "{{ p.dkpc }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
              ];

              const data = [
                {% for p in product_summary|slice:":10" %}
                  {{ p.profit|default_if_none:"0" }}{% if not forloop.last %},{% endif %}
                {% endfor %}
              ];

              const ctx = document.getElementById('profitChart');
              if (!ctx) return;

              const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: labels,
                  datasets: [{
                    label: 'سود (ریال)',
                    data: data,
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    x: {
                      ticks: {
                        maxRotation: 60,
                        minRotation: 30,
                      }
                    },
                    y: {
                      beginAtZero: true,
                    }
                  },
                  plugins: {
                    legend: {
                      display: false,
                    },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          const value = context.parsed.y || 0;
                          return 'سود: ' + value.toLocaleString('fa-IR') + ' ریال';
                        }
                      }
                    }
                  }
                }
              });
            })();
          </script>
        {% endif %}

      {% else %}
        <!-- پیام: هنوز پرداخت نشده -->
        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm p-4 md:p-6 border border-slate-200/80 dark:border-slate-700/60">
          <h2 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">
            جزئیات سود و زیان قفل است
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
            فایل اکسل شما با موفقیت پردازش شده، اما هنوز هزینه‌ی پردازش این صورتحساب پرداخت نشده است.
          </p>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
            بعد از پرداخت، خلاصه سود و زیان، جدول ردیف‌ها و خلاصه‌ی کالاها (به همراه نمودار) در همین صفحه نمایش داده خواهند شد.
          </p>
          <a
            href="{% url 'digihesabyar:invoice_pay' invoice_id=invoice.id %}"
            class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700"
          >
            رفتن به صفحه پرداخت
          </a>
        </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}
